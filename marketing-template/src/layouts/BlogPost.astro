---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import FormattedDate from '../components/molecules/FormattedDate.astro';
import Layout from './PageLayout.astro';
import Prose from '../components/molecules/Prose.astro';
import TableOfContents from '../components/molecules/TableOfContents.astro';
import { SITE, METADATA } from '../consts';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const { title, description, pubDate, updatedDate, heroImage, tags, headings } = Astro.props;

const ogImage = heroImage
	? typeof heroImage === 'string'
		? heroImage
		: heroImage.src
	: undefined;

const absoluteOgImage = ogImage ? new URL(ogImage, SITE.site).href : undefined;

const articleSchema = {
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": title,
	"description": description || METADATA.description,
	"datePublished": pubDate?.toISOString(),
	"dateModified": updatedDate?.toISOString() || pubDate?.toISOString(),
	"author": {
		"@type": "Organization",
		"name": SITE.name,
		"url": SITE.site
	},
	"publisher": {
		"@type": "Organization",
		"name": SITE.name,
		"url": SITE.site,
		"logo": {
			"@type": "ImageObject",
			"url": `${SITE.site}/logo.svg`
		}
	},
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": Astro.url.href
	},
	...(absoluteOgImage && {
		"image": {
			"@type": "ImageObject",
			"url": absoluteOgImage
		}
	})
};
---

<Layout metadata={{ 
	title, 
	description,
	openGraph: {
		type: 'article',
		...(absoluteOgImage && {
			images: [{
				url: absoluteOgImage,
				width: 1200,
				height: 630,
			}]
		})
	}
}}>

	<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
	
	<div class="flex-1">
		<article class="pt-24 md:pt-32 pb-10 md:pb-16">
			<div class="container">
				{headings && headings.length > 0 ? (
					<div class="lg:grid lg:grid-cols-[1fr_256px] lg:gap-12 max-w-5xl mx-auto">
						{/* Main content */}
						<div class="min-w-0">
							<header class="mb-10 text-left">
								<div class="flex justify-start gap-2 mb-6">
									<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium">Blog post</span>
									<span class="px-3 py-1 rounded-full bg-muted text-muted-foreground text-xs font-medium">5 min read</span>
								</div>
								
								<h1 class="text-3xl sm:text-4xl md:text-5xl font-light text-foreground mb-6 tracking-tight">{title}</h1>
								
								{description && (
									<p class="text-xl text-muted-foreground mb-8 leading-relaxed">{description}</p>
								)}

								<div class="flex flex-col items-start gap-3 mb-8">
									<div class="flex items-center gap-3">
										<span class="text-primary font-light text-sm">Written by</span>
										<span class="text-foreground font-light text-sm">Simon Balfe</span>
									</div>
									<div class="flex items-center gap-3">
										<span class="text-primary font-light text-sm">Updated on</span>
										<span class="text-foreground font-light text-sm"><FormattedDate date={updatedDate || pubDate} /></span>
									</div>
								</div>

								{/* Tags */}
								{tags && tags.length > 0 && (
									<div class="flex flex-wrap items-center justify-start gap-3">
										<span class="text-primary font-light text-sm">Tags</span>
										<div class="flex flex-wrap justify-start gap-2">
											{tags.map(tag => (
												<a href={`/blog/tag/${tag}`} class="px-3 py-1 rounded-full border border-border text-sm text-muted-foreground hover:border-primary hover:text-primary transition-colors">
													{tag}
												</a>
											))}
										</div>
									</div>
								)}
							</header>

							{heroImage && (
								<div class="mb-8">
									<Image
										width={1020}
										height={510}
										src={heroImage}
										alt={title}
										class="w-full rounded-xl shadow-lg aspect-video object-cover"
									/>
								</div>
							)}

							<Prose>
								<slot />
							</Prose>
						</div>

						{/* Sidebar TOC - sticky */}
						<aside class="hidden lg:block">
							<div class="sticky top-24 p-6 bg-muted/30 rounded-2xl border border-border max-h-[calc(100vh-8rem)] overflow-y-auto">
								<TableOfContents headings={headings} />
							</div>
						</aside>
					</div>
				) : (
					<div class="max-w-3xl mx-auto">
						<header class="mb-10 text-left">
							<div class="flex justify-start gap-2 mb-6">
								<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium">Blog post</span>
								<span class="px-3 py-1 rounded-full bg-muted text-muted-foreground text-xs font-medium">5 min read</span>
							</div>
							
							<h1 class="text-3xl sm:text-4xl md:text-5xl font-light text-foreground mb-6 tracking-tight">{title}</h1>
							
							{description && (
								<p class="text-xl text-muted-foreground mb-8 leading-relaxed">{description}</p>
							)}

							<div class="flex flex-col items-start gap-3 mb-8">
								<div class="flex items-center gap-3">
									<span class="text-primary font-light text-sm">Written by</span>
									<span class="text-foreground font-light text-sm">Simon Balfe</span>
								</div>
								<div class="flex items-center gap-3">
									<span class="text-primary font-light text-sm">Updated on</span>
									<span class="text-foreground font-light text-sm"><FormattedDate date={updatedDate || pubDate} /></span>
								</div>
							</div>

							{/* Tags */}
							{tags && tags.length > 0 && (
								<div class="flex flex-wrap items-center justify-start gap-3">
									<span class="text-primary font-light text-sm">Tags</span>
									<div class="flex flex-wrap justify-start gap-2">
										{tags.map(tag => (
											<a href={`/blog/tag/${tag}`} class="px-3 py-1 rounded-full border border-border text-sm text-muted-foreground hover:border-primary hover:text-primary transition-colors">
												{tag}
											</a>
										))}
									</div>
								</div>
							)}
						</header>

						{heroImage && (
							<div class="mb-8">
								<Image
									width={1020}
									height={510}
									src={heroImage}
									alt={title}
									class="w-full rounded-xl shadow-lg aspect-video object-cover"
								/>
							</div>
						)}

						<Prose>
							<slot />
						</Prose>
					</div>
				)}
			</div>
		</article>
	</div>

</Layout>
